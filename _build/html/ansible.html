

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Ansible &mdash; OpenShift Compliance Guide 1.0 beta documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="OpenShift Compliance Guide 1.0 beta documentation" href="index.html"/>
        <link rel="next" title="Continuous Compliance" href="continuous_compliance.html"/>
        <link rel="prev" title="Customer Responsibility Matrix" href="crm.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="toc.html" class="icon icon-home"> OpenShift Compliance Guide
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">  Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="sec_conops.html">  Security CONOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="controls.html">  Security Controls</a></li>
<li class="toctree-l1"><a class="reference internal" href="crm.html">  Customer Responsibility Matrix</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">  Ansible</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#automation">Automation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#concept-of-operation">Concept of Operation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#manual-workarounds">Manual Workarounds</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#user-authentication">User Authentication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#request-header-authentication">Request Header Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#openshift-master-creating-certificates">OpenShift Master – Creating Certificates</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apache-proxy">Apache Proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#openshift-master-auth-configuration">OpenShift Master - Auth Configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="continuous_compliance.html">  Continuous Compliance</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">  Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="toc.html">OpenShift Compliance Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="toc.html">Docs</a> &raquo;</li>
      
    <li>Ansible</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/ansible.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ansible">
<span id="id1"></span><h1>Ansible<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h1>
<p>This chapter describes how OCP 3.3 can be deployed according to the FISMA
High security controls listed in this guide. Further, the deployed reference
architecture is &#8220;air-gapped&#8221; in a private AWS VPC with not direct access
to the Internet.</p>
<div class="section" id="automation">
<h2>Automation<a class="headerlink" href="#automation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="concept-of-operation">
<h3>Concept of Operation<a class="headerlink" href="#concept-of-operation" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="manual-workarounds">
<h2>Manual Workarounds<a class="headerlink" href="#manual-workarounds" title="Permalink to this headline">¶</a></h2>
<div class="section" id="user-authentication">
<h3>User Authentication<a class="headerlink" href="#user-authentication" title="Permalink to this headline">¶</a></h3>
<p>Cluster Admins and Application developers gain access to OCP through a WebUI or CLI.  In order to authenticate with the CLI, the user must first log in to the WebUI and obtain a CLI token.  The following details how to enable PKI authentication in the WebUI.</p>
<div class="section" id="request-header-authentication">
<h4>Request Header Authentication<a class="headerlink" href="#request-header-authentication" title="Permalink to this headline">¶</a></h4>
<p>The request header authentication passes the authentication request to another Apache process.  If that process successfully authenticates (and authorizes if desired) the user, then it passes the username back to the OpenShift master in an HTTP header.</p>
<p>This Apache process may be run on the OpenShift master or separate host.  This example assumes the Apache process is on a separate host.</p>
<ol class="arabic simple">
<li>OpenShift Master – master.example.com</li>
<li>Apache proxy for authentication – proxy.example.com</li>
</ol>
</div>
<div class="section" id="openshift-master-creating-certificates">
<h4>OpenShift Master – Creating Certificates<a class="headerlink" href="#openshift-master-creating-certificates" title="Permalink to this headline">¶</a></h4>
<p>OpenShift manages its own certificates to encrypt inter-nodal communication.  This is beneficial in another way.  We don’t want someone to spoof our proxy and authenticate by passing in a remote header from some random host.  Therefore, we will create a certificate for the Apache proxy using the CA on the OpenShift master.</p>
<dl class="docutils">
<dt>SSH to the OpenShift master and elevate your privileges to root.::</dt>
<dd><p class="first"># oadm ca create-signer-cert &#8211;cert=&#8217;/etc/origin/master/proxyca.crt&#8217; &#8211;key=&#8217;/etc/origin/master/proxyca.key&#8217; <a class="reference external" href="mailto:--name='openshift-proxy-signer&#37;&#52;&#48;1432232228">--name='openshift-proxy-signer<span>&#64;</span>1432232228</a>&#8216; &#8211;serial=&#8217;/etc/origin/master/proxyca.serial.txt&#8217;</p>
<p># oadm create-api-client-config &#8211;certificate-authority=&#8217;/etc/origin/master/proxyca.crt&#8217; &#8211;client-dir=&#8217;/etc/origin/master/proxy&#8217; &#8211;signer-cert=&#8217;/etc/origin/master/proxyca.crt&#8217; &#8211;signer-key=&#8217;/etc/origin/master/proxyca.key&#8217; &#8211;signer-serial=&#8217;/etc/origin/master/proxyca.serial.txt&#8217; &#8211;user=&#8217;system:proxy&#8217;</p>
<p class="last"># pushd /etc/origin/master
# cp ca.crt /root/authproxyca.crt
# cat proxy/system:proxy.crt proxy/system:proxy.key &gt; /root/authproxy.crt
# popd</p>
</dd>
</dl>
<p>Using your favorite file transfer method, copy the authproxy.crt and authproxyca.crt from the OpenShift Master to the Apache proxy host.</p>
</div>
<div class="section" id="apache-proxy">
<h4>Apache Proxy<a class="headerlink" href="#apache-proxy" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt>SSH into the Apache Proxy and install some basic packages as root.::</dt>
<dd># yum install -y httpd mod_ssl mod_session apr-util-openssl</dd>
<dt>Also, as root, create a new Apache configuration file with the following content in /etc/httpd/conf.d/::</dt>
<dd><p class="first"># vi /etc/httpd/conf.d/ose-proxy.conf</p>
<p>LoadModule session_module modules/mod_session.so
LoadModule request_module modules/mod_request.so</p>
<p># Nothing needs to be served over HTTP. This virtual host simply redirects to
# HTTPS.
&lt;VirtualHost <em>:80&gt;
DocumentRoot /var/www/html
RewriteEngine On
RewriteRule ^(.</em>)$ <a class="reference external" href="https:/">https:/</a>/%{HTTP_HOST}$1 [R,L]
&lt;/VirtualHost&gt;</p>
<p>&lt;VirtualHost <a href="#id2"><span class="problematic" id="id3">*</span></a>:443&gt;
# This needs to match the certificates you generated. See the CN and X509v3
# Subject Alternative Name in the output of:
# openssl x509 -text -in /etc/pki/tls/certs/localhost.crt
ServerName proxy.example.com</p>
<p>DocumentRoot /var/www/html
SSLEngine on
SSLCertificateFile /etc/pki/tls/certs/localhost.crt
SSLCertificateKeyFile /etc/tls/private/localhost.key</p>
<p>#This is the CA against which your user’s certificates will be checked.
SSLCACertificateFile /etc/pki/tls/certs/ca-bundle.crt</p>
<p>SSLProtocol ALL -SSLv2 -SSLv3
SSLCipherSuite ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH:!EXP:!SSLV2:!eNULL
SSLUserName SSL_CLIENT_S_DN_CN
SSLOptions +StdEnvVars +ExportCertData
#For PKI
SSLVerifyClient require</p>
<p>SSLProxyEngine on</p>
<p>#These were created per the instructions in the OSE installation docs
SSLProxyCACertificateFile /etc/pki/CA/certs/authproxyca.crt
SSLProxyMachineCertificateFile /etc/pki/tls/certs/authproxy.crt</p>
<p>ErrorLog logs/ssl_error_log
TransferLog logs/ssl_access_log
LogLevel debug
CustomLog logs/ssl_request_log “%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x ”%r” %b”
# Send all requests to the console
RewriteEngine On
RewriteRule ^/console(.*)$ <a class="reference external" href="https:/">https:/</a>/%{HTTP_HOST}:8443/console$1 [R,L]</p>
<p># In order to using the challenging-proxy an X-Csrf-Token must be present.
RewriteCond %{REQUEST_URI} ^/challenging-proxy
RewriteCond %{<a class="reference external" href="HTTP:X-Csrf-Token">HTTP:X-Csrf-Token</a>} ^$ [NC]
RewriteRule ^.* – [F,L]</p>
<p>&lt;Location /challenging-proxy/oauth/authorize&gt;
# Insert your backend server name/ip here.
AuthName openshift
ProxyPass <a class="reference external" href="https://master.example.com:8443/oauth/authorize">https://master.example.com:8443/oauth/authorize</a>
&lt;/Location&gt;</p>
<p>&lt;Location /login-proxy/oauth/authorize&gt;
# Insert your backend server name/ip here.
AuthName openshift
ProxyPass <a class="reference external" href="https://master.example.com:8443/oauth/authorize">https://master.example.com:8443/oauth/authorize</a>
&lt;/Location&gt;</p>
<p>&lt;ProxyMatch /oauth/authorize&gt;
#This require directive is very important
require valid-user
RequestHeader set X-Remote-User %{SSL_CLIENT_S_DN_CN}s
&lt;/ProxyMatch&gt;</p>
<p class="last">&lt;/VirtualHost&gt;
RequestHeader unset X-Remote-User</p>
</dd>
</dl>
<p>Please note the SSLCACertificateFile directive.  This is the CA against which the clients (your users) will be validated.  Out of the box, the specified file won’t work.  Please replace this will the valid CA file or chain.</p>
</div>
<div class="section" id="openshift-master-auth-configuration">
<h4>OpenShift Master - Auth Configuration<a class="headerlink" href="#openshift-master-auth-configuration" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt>Now that we have Apache configured, we need to configure the authentication provider for the OpenShift Master.  SSH into the OpenShift Master and elevate your privileges to root.  Then edit the Master’s configuration file:::</dt>
<dd># vi /etc/origin/master/master-config.yaml</dd>
<dt>Now, in the oathConfig section, enter the following::</dt>
<dd><dl class="first last docutils">
<dt>oauthConfig:</dt>
<dd><p class="first">...
identityProviders:
- name: requestheader</p>
<blockquote class="last">
<div><p>challenge: true
login: true
provider:</p>
<blockquote>
<div>apiVersion: v1
kind: RequestHeaderIdentityProvider
challengeURL: &#8220;<a class="reference external" href="https://proxy.example.com/challenging-proxy/oauth/authorize">https://proxy.example.com/challenging-proxy/oauth/authorize</a>?${query}&#8221;
loginURL: &#8220;<a class="reference external" href="https://proxy.example.com/login-proxy/oauth/authorize">https://proxy.example.com/login-proxy/oauth/authorize</a>?${query}&#8221;
clientCA: /etc/origin/master/proxyca.crt
headers:
- X-Remote-User</div></blockquote>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
<p>YAML is delimited by spaces.  Please ensure you have the correct spacing.</p>
<dl class="docutils">
<dt>Once you have saved the file, go ahead and restart your master.::</dt>
<dd># systemctl restart atomic-openshift-master.service</dd>
</dl>
<p>Now navigate to your OpenShift master in a web browser.  If you have a valid client certificate, you should just be authenticated.</p>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="continuous_compliance.html" class="btn btn-neutral float-right" title="Continuous Compliance" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="crm.html" class="btn btn-neutral" title="Customer Responsibility Matrix" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Red Hat.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0 beta',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>